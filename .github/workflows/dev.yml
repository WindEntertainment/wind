name: dev

on:
  push:
    branches:
      - '**'
      - '!master'

permissions:
  contents: write
jobs:
  # linting:
  #   name: Linting
  #   runs-on: ${{ matrix.config.os }}
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       config:
  #         - {
  #             name: 'Ubuntu',
  #             projectRoot: '/home/runner/work/dreich',
  #             artifact: 'linux.tar.xz',
  #             os: 'ubuntu-latest',
  #             scriptBuildType: 'build',
  #             engineBuildType: 'Debug',
  #             uiRoot: '/home/runner/work/dreich/dreich/game/assets/UI',
  #             scriptRoot: '/home/runner/work/dreich/dreich/game/assets/scripts',
  #             engineRoot: '/home/runner/work/dreich/dreich',
  #             cc: 'clang',
  #             cxx: 'clang++',
  #           }
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - name: Add env
  #       shell: bash
  #       run: |
  #         echo "name=${{ matrix.config.name }}" >> $GITHUB_ENV
  #         echo "projectRoot=${{ matrix.config.projectRoot }}" >> $GITHUB_ENV
  #         echo "artifact=${{ matrix.config.artifact }}" >> $GITHUB_ENV
  #         echo "os=${{ matrix.config.os }}" >> $GITHUB_ENV
  #         echo "scriptBuildType=${{ matrix.config.scriptBuildType }}" >> $GITHUB_ENV
  #         echo "engineBuildType=${{ matrix.config.engineBuildType }}" >> $GITHUB_ENV
  #         echo "uiRoot=${{ matrix.config.uiRoot }}" >> $GITHUB_ENV
  #         echo "scriptRoot=${{ matrix.config.scriptRoot }}" >> $GITHUB_ENV
  #         echo "engineRoot=${{ matrix.config.engineRoot }}" >> $GITHUB_ENV
  #         echo "cc=${{ matrix.config.cc }}" >> $GITHUB_ENV
  #         echo "cxx=${{ matrix.config.cxx }}" >> $GITHUB_ENV
  #     - name: List env
  #       shell: bash
  #       run: |
  #         echo ${{ env.name }}
  #         echo ${{ env.artifact }}
  #         echo ${{ env.os }}
  #         echo ${{ env.scriptBuildType }}
  #         echo ${{ env.engineBuildType }}
  #         echo ${{ env.uiRoot }}
  #         echo ${{ env.scriptRoot }}
  #         echo ${{ env.engineRoot }}
  #     - name: UI
  #       uses: './.github/workflows/modules/ui/lint'
  #     - name: Scripts
  #       uses: './.github/workflows/modules/scripts/lint'
  #     - name: Engine
  #       uses: './.github/workflows/modules/engine/lint'
  #     - name: Linting commit
  #       uses: './.github/workflows/utils/commit'

  # testing:
  #   name: 'Testing: ${{ matrix.config.name }}'
  #   runs-on: ${{ matrix.config.os }}
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       config:
  #         - {
  #             name: 'Windows',
  #             projectRoot: '/d/a/dreich',
  #             artifact: 'windows.tar.xz',
  #             os: 'windows-latest',
  #             scriptBuildType: 'build',
  #             engineBuildType: 'Debug',
  #             uiRoot: '/d/a/dreich/dreich/game/assets/UI',
  #             scriptRoot: '/d/a/dreich/dreich/game/assets/scripts',
  #             engineRoot: '/d/a/dreich/dreich',
  #             cc: 'clang',
  #             cxx: 'clang++',
  #           }
  #         - {
  #             name: 'Ubuntu',
  #             projectRoot: '/home/runner/work/dreich',
  #             artifact: 'linux.tar.xz',
  #             os: 'ubuntu-latest',
  #             scriptBuildType: 'build',
  #             engineBuildType: 'Debug',
  #             uiRoot: '/home/runner/work/dreich/dreich/game/assets/UI',
  #             scriptRoot: '/home/runner/work/dreich/dreich/game/assets/scripts',
  #             engineRoot: '/home/runner/work/dreich/dreich',
  #             cc: 'clang',
  #             cxx: 'clang++',
  #           }
  #         - {
  #             name: 'MacOS',
  #             projectRoot: '/Users/runner/work/dreich',
  #             artifact: 'macos.tar.xz',
  #             os: 'macos-14',
  #             scriptBuildType: 'build',
  #             engineBuildType: 'Debug',
  #             uiRoot: '/Users/runner/work/dreich/dreich/game/assets/UI',
  #             scriptRoot: '/Users/runner/work/dreich/dreich/game/assets/scripts',
  #             engineRoot: '/Users/runner/work/dreich/dreich',
  #             cc: 'clang',
  #             cxx: 'clang++',
  #           }
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - name: Add env
  #       shell: bash
  #       run: |
  #         echo "name=${{ matrix.config.name }}" >> $GITHUB_ENV
  #         echo "projectRoot=${{ matrix.config.projectRoot }}" >> $GITHUB_ENV
  #         echo "artifact=${{ matrix.config.artifact }}" >> $GITHUB_ENV
  #         echo "os=${{ matrix.config.os }}" >> $GITHUB_ENV
  #         echo "scriptBuildType=${{ matrix.config.scriptBuildType }}" >> $GITHUB_ENV
  #         echo "engineBuildType=${{ matrix.config.engineBuildType }}" >> $GITHUB_ENV
  #         echo "uiRoot=${{ matrix.config.uiRoot }}" >> $GITHUB_ENV
  #         echo "scriptRoot=${{ matrix.config.scriptRoot }}" >> $GITHUB_ENV
  #         echo "engineRoot=${{ matrix.config.engineRoot }}" >> $GITHUB_ENV
  #         echo "cc=${{ matrix.config.cc }}" >> $GITHUB_ENV
  #         echo "cxx=${{ matrix.config.cxx }}" >> $GITHUB_ENV
  #     - name: List env
  #       shell: bash
  #       run: |
  #         echo ${{ env.name }}
  #         echo ${{ env.artifact }}
  #         echo ${{ env.os }}
  #         echo ${{ env.scriptBuildType }}
  #         echo ${{ env.engineBuildType }}
  #         echo ${{ env.uiRoot }}
  #         echo ${{ env.scriptRoot }}
  #         echo ${{ env.engineRoot }}
  #     - uses: ./.github/workflows/utils/setup-base-libs
  #     - name: Scripts
  #       uses: './.github/workflows/modules/scripts/test'
  #     - name: Engine
  #       uses: './.github/workflows/modules/engine/test'

  building:
    name: 'Build: ${{ matrix.config.name }}'
    runs-on: ${{ matrix.config.os }}
    # needs:
    #   - linting
    #   - testing
    strategy:
      fail-fast: false
      matrix:
        config:
          # - {
          #     name: 'Windows',
          #     projectRoot: '/d/a/dreich',
          #     artifact: 'windows.tar.xz',
          #     os: 'windows-latest',
          #     scriptBuildType: 'build',
          #     engineBuildType: 'Debug',
          #     uiRoot: '/d/a/dreich/dreich/game/assets/UI',
          #     scriptRoot: '/d/a/dreich/dreich/game/assets/scripts',
          #     engineRoot: '/d/a/dreich/dreich',
          #     cc: 'clang',
          #     cxx: 'clang++',
          #   }
          # - {
          #     name: 'Ubuntu',
          #     projectRoot: '/home/runner/work/dreich',
          #     artifact: 'linux.tar.xz',
          #     os: 'ubuntu-latest',
          #     scriptBuildType: 'build',
          #     engineBuildType: 'Debug',
          #     uiRoot: '/home/runner/work/dreich/dreich/game/assets/UI',
          #     scriptRoot: '/home/runner/work/dreich/dreich/game/assets/scripts',
          #     engineRoot: '/home/runner/work/dreich/dreich',
          #     cc: 'clang',
          #     cxx: 'clang++',
          #   }
          - {
              name: 'MacOS',
              projectRoot: '/Users/runner/work/dreich',
              artifact: 'macos.tar.xz',
              os: 'macos-14',
              scriptBuildType: 'build',
              engineBuildType: 'Debug',
              uiRoot: '/Users/runner/work/dreich/dreich/game/assets/UI',
              scriptRoot: '/Users/runner/work/dreich/dreich/game/assets/scripts',
              engineRoot: '/Users/runner/work/dreich/dreich',
              cc: 'clang',
              cxx: 'clang++',
            }
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Add env
        shell: bash
        run: |
          # echo "name=${{ matrix.config.name }}" >> $GITHUB_ENV
          # echo "projectRoot=${{ matrix.config.projectRoot }}" >> $GITHUB_ENV
          # echo "artifact=${{ matrix.config.artifact }}" >> $GITHUB_ENV
          # echo "os=${{ matrix.config.os }}" >> $GITHUB_ENV
          # echo "scriptBuildType=${{ matrix.config.scriptBuildType }}" >> $GITHUB_ENV
          # echo "engineBuildType=${{ matrix.config.engineBuildType }}" >> $GITHUB_ENV
          # echo "uiRoot=${{ matrix.config.uiRoot }}" >> $GITHUB_ENV
          # echo "scriptRoot=${{ matrix.config.scriptRoot }}" >> $GITHUB_ENV
          # echo "engineRoot=${{ matrix.config.engineRoot }}" >> $GITHUB_ENV
          # echo "cc=${{ matrix.config.cc }}" >> $GITHUB_ENV
          # echo "cxx=${{ matrix.config.cxx }}" >> $GITHUB_ENV
          for key in "${!matrix.config[@]}"; do
            echo "${key}=${matrix.config[$key]}" >> $GITHUB_ENV
          done

      - name: List env
        shell: bash
        run: |
          echo ${{ env.name }}
          echo ${{ env.artifact }}
          echo ${{ env.os }}
          echo ${{ env.scriptBuildType }}
          echo ${{ env.engineBuildType }}
          echo ${{ env.uiRoot }}
          echo ${{ env.scriptRoot }}
          echo ${{ env.engineRoot }}
      - name: UI
        uses: './.github/workflows/modules/ui/build'
      - uses: ./.github/workflows/utils/setup-base-libs
      - name: Scripts
        uses: './.github/workflows/modules/scripts/build'
      - name: Engine
        uses: './.github/workflows/modules/engine/build'
