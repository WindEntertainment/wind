name: Setup ultralight
description: Setup ultralight

runs:
  using: 'composite'
  steps:
    # - name: Caching ultralight
    #   uses: './.github/workflows/utils/cache/get-ultralight-cache'

    # - name: Get ultralight keys prefix
    #   shell: bash
    #   run: |
    #     echo "ULTRALIGHT_KEYS_PREFIX=${{ runner.os }}-ultralight-store-" >> $GITHUB_ENV

    - uses: actions/cache@v4
      name: Setup ultralight cache
      with:
        path: $(pwd)
        key: ${{ runner.os }}-ultralight-store-
        restore-keys: |
          ${{ runner.os }}-ultralight-store-

    - name: Check if Ultralight is cached
      id: check-cache
      shell: bash
      run: |
        echo "::set-output name=ultralight-cached::$(if [ -d 'ultralight/ultralight' ]; then echo 'true'; else echo 'false'; fi)"

    - name: Install ultralight
      shell: bash
      if: steps.check-cache.outputs.ultralight-cached == 'false'
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          cd ../
          mkdir ultralight
          cd ultralight

          wget https://ultralight-files.sfo3.cdn.digitaloceanspaces.com/ultralight-sdk-1.3.0-linux-x64.7z
          7za x ultralight-sdk-1.3.0-linux-x64.7z
          echo "ULTRALIGHT_PATH=$(pwd)" >> $GITHUB_ENV
        elif [ "$RUNNER_OS" == "Windows" ]; then
          echo "ULTRALIGHT_PATH=C:\\\a\\\dreich\\\ultralight" >> $GITHUB_ENV
        elif [ "$RUNNER_OS" == "macOS" ]; then
          cd ../
          mkdir ultralight
          cd ultralight

          wget https://ultralight-files.sfo3.cdn.digitaloceanspaces.com/ultralight-sdk-1.4.0a-mac-arm64.7z
          7za x ultralight-sdk-1.4.0a-mac-arm64.7z

          echo -e "#include <Ultralight/String.h>\n$(cat SDK/include/Ultralight/ConsoleMessage.h )" > SDK/include/Ultralight/ConsoleMessage.h

          echo "ULTRALIGHT_PATH=$(pwd)/SDK" >> $GITHUB_ENV
        else
          echo "$RUNNER_OS not supported"
          exit 1
        fi

    - name: Install ultralight
      if: env.os == 'windows-latest'
      shell: powershell
      run: |
        cd ../
        New-Item -ItemType Directory -Path ultralight
        cd ultralight

        Invoke-WebRequest -Uri https://ultralight-files.sfo3.cdn.digitaloceanspaces.com/ultralight-sdk-1.4.0a-win-x64.7z -OutFile ultralight-sdk.7z
        7z x ultralight-sdk.7z -o"ultralight"
